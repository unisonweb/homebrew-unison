name: "release"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version'
        required: true
        type: string

jobs:
  update_formula:
    name: "update_formula"
    runs-on: "ubuntu-latest"

    steps:
      - uses: actions/checkout@v2

      - name: "Download artifacts and bump homebrew version"
        run: |
          tries=24
          for (( i = 0; i < $tries; i++ )); do
            # It's possible for this job to be kicked off before the release has been created,
            # We'll keep trying for 2 hrs, since Windows can take a long time to build.
            if gh release download --repo unisonweb/unison release/${{inputs.version}} ; then
              break
            echo "Couldn't download release artifacts, release may not yet exist. Trying again in 5 minutes."
            sleep 300 # If we failed, wait for 5 minutes
          done
          linux_sha=$(cat ucm-linux.tar.gz | shasum -a 256 | cut -f1 -d" ")
          macos_sha=$(cat ucm-macos.tar.gz | shasum -a 256 | cut -f1 -d" ")
          # Generate formula with correct version and SHAs.
          cat unison-language.rb.template | sed "s/{{macos_sha}}/${macos_sha}/g;s/{{linux_sha}}/${linux_sha}/g;s/{{version}}/${version}/g;" > unison-language.rb
          git add unison-language.rb
          git commit -m "release/${version}"
          git push origin master
